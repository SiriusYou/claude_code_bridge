#!/usr/bin/env bash
# ccb-mounted - Check which CCB providers are mounted
# Usage: ccb-mounted [--json|--simple]

set -euo pipefail

PROVIDERS="codex:cask gemini:gask opencode:oask claude:lask droid:dask"
CWD="${1:-$(pwd)}"
FORMAT="${2:---json}"

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "$0")" && pwd)"

# Normalize CWD for Windows (convert /e/... to E:/...)
if [[ "$OSTYPE" == "msys" ]] || [[ "$OSTYPE" == "cygwin" ]]; then
  # Convert msys path /e/foo to E:/foo
  if [[ "$CWD" =~ ^/([a-zA-Z])/ ]]; then
    CWD="${BASH_REMATCH[1]^}:${CWD:2}"
  fi
fi

# Check mounted providers using ping command
# This works with both legacy per-provider daemons and the unified askd daemon
MOUNTED=""
for pair in $PROVIDERS; do
  provider="${pair%%:*}"
  # Check session file exists first
  if [[ -f "$CWD/.ccb_config/.${provider}-session" ]] || [[ -f "$CWD/.${provider}-session" ]]; then
    # Try the ping command to check if daemon is responsive
    if "$SCRIPT_DIR/ping" "$provider" >/dev/null 2>&1; then
      MOUNTED="$MOUNTED $provider"
    fi
  fi
done

MOUNTED=$(echo $MOUNTED | xargs)  # trim

case "$FORMAT" in
  --simple)
    echo "$MOUNTED"
    ;;
  --json|*)
    if [[ -z "$MOUNTED" ]]; then
      echo "{\"cwd\":\"$CWD\",\"mounted\":[]}"
    else
      JSON_ARRAY=$(echo "$MOUNTED" | sed 's/ /","/g;s/^/"/;s/$/"/')
      echo "{\"cwd\":\"$CWD\",\"mounted\":[$JSON_ARRAY]}"
    fi
    ;;
esac
